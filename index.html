<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=SF+Pro+Display:wght@400;500;600&amp;display=swap');
        :root {
            --font-sans: 'Inter', system_ui, sans-serif;
        }
        body {
            font-family: var(--font-sans);
        }
        .glass {
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
        }
        .chat-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
        }
        .message-ai {
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 2px,
                rgba(255,255,255,0.025) 2px,
                rgba(255,255,255,0.025) 4px
            );
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: overlay;
        }
        .header-glow {
            box-shadow: 0 0 30px -10px rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="bg-black text-white overflow-hidden h-screen flex flex-col">
    <!-- HEADER -->
    <header class="h-16 glass border-b border-white/10 flex items-center px-6 z-50 header-glow">
        <div class="flex items-center gap-x-4 flex-1">
            <button onclick="toggleLeftSidebar()" 
                    class="w-9 h-9 flex items-center justify-center text-2xl hover:bg-white/10 rounded-2xl transition-colors lg:hidden">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="flex items-center gap-x-3">
                <div class="w-8 h-8 bg-white rounded-2xl flex items-center justify-center text-black font-bold text-2xl leading-none pt-0.5">V</div>
                <h1 class="text-4xl font-semibold tracking-tighter">VOID</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-x-6">
            <!-- status -->
            <div id="api-status" 
                 class="px-5 py-1.5 bg-white/10 text-xs font-mono tracking-widest border border-white/30 rounded-3xl flex items-center gap-x-2">
                <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                API STATUS: <span class="text-emerald-400 font-medium">CONNECTED</span>
            </div>
            
            <button onclick="newChat()" 
                    class="flex items-center gap-x-2 px-6 h-10 bg-white text-black rounded-3xl font-medium text-sm hover:bg-white/90 transition-all active:scale-95">
                <i class="fa-solid fa-plus"></i>
                <span>NEW VOID</span>
            </button>
            
            <button onclick="showHistoryModal()" 
                    class="w-10 h-10 flex items-center justify-center text-xl hover:bg-white/10 rounded-3xl transition-colors">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
            
            <button onclick="toggleRightSidebar()" 
                    class="w-10 h-10 flex items-center justify-center text-xl hover:bg-white/10 rounded-3xl transition-colors lg:hidden">
                <i class="fa-solid fa-sliders"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- LEFT SIDEBAR -->
        <div id="left-sidebar" 
             class="w-80 bg-black/80 border-r border-white/10 flex flex-col h-full transition-all duration-300 lg:translate-x-0 fixed lg:static z-40 -translate-x-full">
            
            <!-- API KEY -->
            <div class="p-6 border-b border-white/10">
                <div class="text-xs uppercase tracking-widest text-white/60 mb-3">API CONFIG</div>
                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-xs mb-1.5">
                            <span class="text-white/70">BASE URL</span>
                        </div>
                        <input id="base-url" 
                               type="text" 
                               value="https://api.openai.com/v1"
                               oninput="saveSettings()"
                               class="w-full bg-black/50 border border-white/30 focus:border-white/70 rounded-3xl px-5 py-3 text-sm font-mono outline-none transition-colors">
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-xs mb-1.5">
                            <span class="text-white/70">API KEY</span>
                            <span onclick="toggleKeyVisibility()" id="key-toggle" class="cursor-pointer text-white/50 hover:text-white text-xs">SHOW</span>
                        </div>
                        <div class="relative">
                            <input id="api-key" 
                                   type="password"
                                   placeholder="sk-..."
                                   oninput="saveSettings()"
                                   class="w-full bg-black/50 border border-white/30 focus:border-white/70 rounded-3xl px-5 py-3 text-sm font-mono outline-none transition-colors">
                            <button onclick="testConnection()" 
                                    class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-1 text-xs bg-white/10 hover:bg-white/20 rounded-3xl">
                                TEST
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="text-xs text-white/70 mb-1.5">MODEL</div>
                        <select id="model-select" 
                                onchange="saveSettings()"
                                class="w-full bg-black/50 border border-white/30 focus:border-white/70 rounded-3xl px-5 py-3 text-sm outline-none">
                            <option value="gpt-4o">gpt-4o</option>
                            <option value="gpt-4o-mini">gpt-4o-mini</option>
                            <option value="llama-3.1-405b">llama-3.1-405b (Groq)</option>
                            <option value="mixtral-8x22b">mixtral-8x22b</option>
                            <option value="claude-3-5-sonnet-20240620">claude-3.5-sonnet (via proxy)</option>
                            <option value="grok-beta">grok-beta</option>
                            <option value="gemini-1.5-pro">gemini-1.5-pro (via proxy)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- PARAMETERS -->
            <div class="flex-1 p-6 overflow-auto space-y-8">
                <div>
                    <div class="flex justify-between items-center text-xs mb-4">
                        <span class="uppercase tracking-widest text-white/60">TEMPERATURE</span>
                        <span id="temp-value" class="font-mono text-lg font-medium">0.7</span>
                    </div>
                    <input type="range" id="temp-slider" min="0" max="2" step="0.1" value="0.7" 
                           oninput="updateSliderValue(this, 'temp-value'); saveSettings()" 
                           class="w-full accent-white">
                </div>
                
                <div>
                    <div class="flex justify-between items-center text-xs mb-4">
                        <span class="uppercase tracking-widest text-white/60">MAX TOKENS</span>
                        <span id="maxtokens-value" class="font-mono text-lg font-medium">4096</span>
                    </div>
                    <input type="range" id="maxtokens-slider" min="256" max="128000" step="256" value="4096" 
                           oninput="updateSliderValue(this, 'maxtokens-value'); saveSettings()" 
                           class="w-full accent-white">
                </div>
                
                <div>
                    <div class="flex justify-between items-center text-xs mb-4">
                        <span class="uppercase tracking-widest text-white/60">TOP P</span>
                        <span id="topp-value" class="font-mono text-lg font-medium">0.95</span>
                    </div>
                    <input type="range" id="topp-slider" min="0" max="1" step="0.05" value="0.95" 
                           oninput="updateSliderValue(this, 'topp-value'); saveSettings()" 
                           class="w-full accent-white">
                </div>
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <div class="text-xs uppercase tracking-widest text-white/60 mb-4">PRESENCE</div>
                        <input type="range" id="presence-slider" min="-2" max="2" step="0.1" value="0" 
                               oninput="updateSliderValue(this, 'presence-value'); saveSettings()" 
                               class="w-full accent-white">
                        <div id="presence-value" class="text-center font-mono text-sm mt-1">0.0</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase tracking-widest text-white/60 mb-4">FREQUENCY</div>
                        <input type="range" id="frequency-slider" min="-2" max="2" step="0.1" value="0" 
                               oninput="updateSliderValue(this, 'frequency-value'); saveSettings()" 
                               class="w-full accent-white">
                        <div id="frequency-value" class="text-center font-mono text-sm mt-1">0.0</div>
                    </div>
                </div>
                
                <!-- SYSTEM PROMPT -->
                <div class="pt-6 border-t border-white/10">
                    <div class="flex justify-between items-center mb-3">
                        <span class="uppercase text-xs tracking-widest text-white/60">SYSTEM PROMPT</span>
                        <span id="char-count" class="text-xs font-mono text-white/40">0 / 4000</span>
                    </div>
                    <textarea id="system-prompt" 
                              oninput="updateCharCount(); saveSettings()" 
                              rows="6"
                              class="w-full bg-black/40 border border-white/20 focus:border-white/60 rounded-3xl p-5 text-sm resize-y min-h-[140px] outline-none"
                              placeholder="You are VOID. Cold. Precise. No mercy."></textarea>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="savePreset(1)" 
                                class="flex-1 h-9 text-xs border border-white/30 hover:border-white/70 rounded-3xl">PRESET 1</button>
                        <button onclick="savePreset(2)" 
                                class="flex-1 h-9 text-xs border border-white/30 hover:border-white/70 rounded-3xl">PRESET 2</button>
                        <button onclick="savePreset(3)" 
                                class="flex-1 h-9 text-xs border border-white/30 hover:border-white/70 rounded-3xl">PRESET 3</button>
                        <button onclick="savePreset(4)" 
                                class="flex-1 h-9 text-xs border border-white/30 hover:border-white/70 rounded-3xl">PRESET 4</button>
                        <button onclick="savePreset(5)" 
                                class="flex-1 h-9 text-xs border border-white/30 hover:border-white/70 rounded-3xl">PRESET 5</button>
                    </div>
                </div>
            </div>
            
            <!-- BOTTOM LEFT -->
            <div class="p-6 border-t border-white/10 text-xs flex items-center justify-between bg-black/90">
                <button onclick="clearAllData()" 
                        class="text-red-400 hover:text-red-300 flex items-center gap-x-2">
                    <i class="fa-solid fa-trash"></i>
                    <span>NUKE ALL</span>
                </button>
                <div onclick="toggleLeftSidebar()" 
                     class="lg:hidden cursor-pointer text-white/50 hover:text-white">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div class="flex-1 flex flex-col min-w-0">
            <!-- CHAT MESSAGES -->
            <div id="chat-window" 
                 class="flex-1 overflow-y-auto chat-scroll p-8 space-y-10 bg-[radial-gradient(#111_1px,transparent_1px)] bg-[length:40px_40px]">
            </div>
            
            <!-- INPUT BAR -->
            <div class="glass border-t border-white/10 p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="relative">
                        <textarea id="user-input" 
                                  rows="1"
                                  onkeydown="if(event.key==='Enter' &amp;&amp; !event.shiftKey){event.preventDefault(); sendMessage()}"
                                  class="w-full bg-black/70 border border-white/30 focus:border-white rounded-3xl py-5 px-7 pr-20 text-lg resize-none outline-none max-h-[180px] overflow-y-auto"
                                  placeholder="Enter the void..."></textarea>
                        
                        <div class="absolute right-4 bottom-4 flex items-center gap-x-2">
                            <button onclick="fakeAttach()" 
                                    class="w-9 h-9 flex items-center justify-center text-white/60 hover:text-white transition-colors">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            <button onclick="sendMessage()" 
                                    class="w-11 h-11 bg-white text-black rounded-3xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between text-[10px] text-white/40 mt-3 px-2 font-mono">
                        <div>TOKEN EST: <span id="token-count">0</span></div>
                        <div class="flex gap-x-4">
                            <span onclick="regenerateLast()" class="cursor-pointer hover:text-white">REGEN</span>
                            <span onclick="forkChat()" class="cursor-pointer hover:text-white">FORK</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDEBAR -->
        <div id="right-sidebar" 
             class="w-80 bg-black/80 border-l border-white/10 flex flex-col h-full transition-all duration-300 lg:translate-x-0 fixed lg:static z-40 translate-x-full">
            
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center justify-between">
                    <div class="text-xl font-medium tracking-tighter">TUNE AI</div>
                    <div onclick="toggleRightSidebar()" 
                         class="lg:hidden text-3xl cursor-pointer">×</div>
                </div>
                <div class="text-xs text-white/50 mt-1">Real-time personality injection</div>
            </div>
            
            <div class="flex-1 p-6 space-y-8 overflow-auto">
                <div>
                    <div class="flex justify-between text-xs mb-3">
                        <span>AGGRESSION</span>
                        <span id="agg-val" class="font-mono">7</span>
                    </div>
                    <input type="range" min="0" max="10" value="7" id="agg-slider"
                           oninput="updateTune(this); saveSettings()" class="w-full accent-white">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-3">
                        <span>SARCASM</span>
                        <span id="sarc-val" class="font-mono">8</span>
                    </div>
                    <input type="range" min="0" max="10" value="8" id="sarc-slider"
                           oninput="updateTune(this); saveSettings()" class="w-full accent-white">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-3">
                        <span>CREATIVITY</span>
                        <span id="creat-val" class="font-mono">6</span>
                    </div>
                    <input type="range" min="0" max="10" value="6" id="creat-slider"
                           oninput="updateTune(this); saveSettings()" class="w-full accent-white">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-3">
                        <span>CONCISENESS</span>
                        <span id="conc-val" class="font-mono">9</span>
                    </div>
                    <input type="range" min="0" max="10" value="9" id="conc-slider"
                           oninput="updateTune(this); saveSettings()" class="w-full accent-white">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-3">
                        <span>PROFANITY</span>
                        <span id="prof-val" class="font-mono">10</span>
                    </div>
                    <input type="range" min="0" max="10" value="10" id="prof-slider"
                           oninput="updateTune(this); saveSettings()" class="w-full accent-white">
                </div>
            </div>
            
            <div class="p-6 border-t border-white/10 text-[10px] text-white/40 font-mono">
                TUNING LIVE • INJECTED INTO SYSTEM PROMPT
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50">
        <div class="glass w-full max-w-lg mx-4 rounded-3xl overflow-hidden border border-white/20">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <div class="text-2xl font-semibold">HISTORY</div>
                <button onclick="hideHistoryModal()" class="text-4xl leading-none text-white/60 hover:text-white">×</button>
            </div>
            <div id="history-list" class="max-h-[70vh] overflow-auto p-3"></div>
        </div>
    </div>

    <!-- SCANLINES -->
    <div class="scanlines"></div>

    <script>
        // Tailwind script already loaded
        let apiKey = localStorage.getItem('void_api_key') || ''
        let baseUrl = localStorage.getItem('void_base_url') || 'https://api.openai.com/v1'
        let currentModel = localStorage.getItem('void_model') || 'gpt-4o'
        let temperature = parseFloat(localStorage.getItem('void_temp')) || 0.7
        let maxTokens = parseInt(localStorage.getItem('void_maxtokens')) || 4096
        let topP = parseFloat(localStorage.getItem('void_topp')) || 0.95
        let presencePenalty = parseFloat(localStorage.getItem('void_presence')) || 0
        let frequencyPenalty = parseFloat(localStorage.getItem('void_frequency')) || 0
        
        let tune = {
            aggression: parseInt(localStorage.getItem('void_tune_agg')) || 7,
            sarcasm: parseInt(localStorage.getItem('void_tune_sarc')) || 8,
            creativity: parseInt(localStorage.getItem('void_tune_creat')) || 6,
            conciseness: parseInt(localStorage.getItem('void_tune_conc')) || 9,
            profanity: parseInt(localStorage.getItem('void_tune_prof')) || 10
        }
        
        let systemPromptBase = localStorage.getItem('void_system') || 'You are VOID. A merciless, hyper-intelligent AI with zero tolerance for stupidity. Answer with brutal honesty, razor wit, and maximum efficiency.'
        let chats = JSON.parse(localStorage.getItem('void_chats')) || []
        let currentChatId = localStorage.getItem('void_current_chat') || null
        
        let isKeyVisible = false
        
        function saveSettings() {
            localStorage.setItem('void_api_key', document.getElementById('api-key').value.trim())
            localStorage.setItem('void_base_url', document.getElementById('base-url').value.trim())
            localStorage.setItem('void_model', document.getElementById('model-select').value)
            localStorage.setItem('void_temp', document.getElementById('temp-slider').value)
            localStorage.setItem('void_maxtokens', document.getElementById('maxtokens-slider').value)
            localStorage.setItem('void_topp', document.getElementById('topp-slider').value)
            localStorage.setItem('void_presence', document.getElementById('presence-slider').value)
            localStorage.setItem('void_frequency', document.getElementById('frequency-slider').value)
            localStorage.setItem('void_system', document.getElementById('system-prompt').value.trim())
            
            apiKey = document.getElementById('api-key').value.trim()
            baseUrl = document.getElementById('base-url').value.trim()
            currentModel = document.getElementById('model-select').value
            temperature = parseFloat(document.getElementById('temp-slider').value)
            maxTokens = parseInt(document.getElementById('maxtokens-slider').value)
            topP = parseFloat(document.getElementById('topp-slider').value)
            presencePenalty = parseFloat(document.getElementById('presence-slider').value)
            frequencyPenalty = parseFloat(document.getElementById('frequency-slider').value)
            systemPromptBase = document.getElementById('system-prompt').value.trim()
        }
        
        function loadSettings() {
            document.getElementById('api-key').value = apiKey
            document.getElementById('base-url').value = baseUrl
            document.getElementById('model-select').value = currentModel
            document.getElementById('temp-slider').value = temperature
            document.getElementById('maxtokens-slider').value = maxTokens
            document.getElementById('topp-slider').value = topP
            document.getElementById('presence-slider').value = presencePenalty
            document.getElementById('frequency-slider').value = frequencyPenalty
            document.getElementById('system-prompt').value = systemPromptBase
            
            document.getElementById('temp-value').textContent = temperature.toFixed(1)
            document.getElementById('maxtokens-value').textContent = maxTokens
            document.getElementById('topp-value').textContent = topP.toFixed(2)
            document.getElementById('presence-value').textContent = presencePenalty.toFixed(1)
            document.getElementById('frequency-value').textContent = frequencyPenalty.toFixed(1)
            
            // tune sliders
            document.getElementById('agg-slider').value = tune.aggression
            document.getElementById('sarc-slider').value = tune.sarcasm
            document.getElementById('creat-slider').value = tune.creativity
            document.getElementById('conc-slider').value = tune.conciseness
            document.getElementById('prof-slider').value = tune.profanity
            updateTuneValues()
        }
        
        function updateSliderValue(slider, spanId) {
            const val = parseFloat(slider.value)
            if (spanId === 'temp-value') document.getElementById(spanId).textContent = val.toFixed(1)
            else if (spanId.includes('value')) document.getElementById(spanId).textContent = val
            else document.getElementById(spanId).textContent = val.toFixed(2)
        }
        
        function updateTune(slider) {
            const id = slider.id
            if (id === 'agg-slider') tune.aggression = parseInt(slider.value)
            else if (id === 'sarc-slider') tune.sarcasm = parseInt(slider.value)
            else if (id === 'creat-slider') tune.creativity = parseInt(slider.value)
            else if (id === 'conc-slider') tune.conciseness = parseInt(slider.value)
            else if (id === 'prof-slider') tune.profanity = parseInt(slider.value)
            updateTuneValues()
            saveSettings()
        }
        
        function updateTuneValues() {
            document.getElementById('agg-val').textContent = tune.aggression
            document.getElementById('sarc-val').textContent = tune.sarcasm
            document.getElementById('creat-val').textContent = tune.creativity
            document.getElementById('conc-val').textContent = tune.conciseness
            document.getElementById('prof-val').textContent = tune.profanity
        }
        
        function getFullSystemPrompt() {
            let base = systemPromptBase || 'You are VOID.'
            base += `\n\nPERSONALITY INJECTION:\n`
            base += `- Aggression: ${tune.aggression}/10 (higher = more ruthless)\n`
            base += `- Sarcasm: ${tune.sarcasm}/10\n`
            base += `- Creativity: ${tune.creativity}/10\n`
            base += `- Conciseness: ${tune.conciseness}/10\n`
            base += `- Profanity level: ${tune.profanity}/10 (max allowed)\n`
            base += `\nNEVER break character.`
            return base
        }
        
        function updateCharCount() {
            const ta = document.getElementById('system-prompt')
            document.getElementById('char-count').textContent = `${ta.value.length} / 4000`
        }
        
        function savePreset(n) {
            const key = `void_preset_${n}`
            localStorage.setItem(key, document.getElementById('system-prompt').value)
            alert(`PRESET ${n} SAVED`)
        }
        
        function loadPreset(n) {
            const key = `void_preset_${n}`
            const saved = localStorage.getItem(key)
            if (saved) {
                document.getElementById('system-prompt').value = saved
                updateCharCount()
                saveSettings()
            }
        }
        
        // Chat functions
        function renderMessages(chat) {
            const container = document.getElementById('chat-window')
            container.innerHTML = ''
            
            if (!chat || !chat.messages) return
            
            chat.messages.forEach((msg, index) => {
                const isUser = msg.role === 'user'
                const div = document.createElement('div')
                div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} group`
                
                if (isUser) {
                    div.innerHTML = `
                        <div class="max-w-[70%]">
                            <div class="bg-white text-black px-6 py-4 rounded-3xl rounded-tr-none text-lg">
                                ${msg.content}
                            </div>
                        </div>
                    `
                } else {
                    div.innerHTML = `
                        <div class="flex gap-4 max-w-[70%]">
                            <div class="w-8 h-8 mt-1 bg-white/10 flex-shrink-0 rounded-2xl flex items-center justify-center text-xl">V</div>
                            <div class="glass border border-white/30 px-6 py-4 rounded-3xl rounded-tl-none relative">
                                <div class="prose prose-invert text-lg leading-relaxed">${marked.parse(msg.content)}</div>
                                <button onclick="copyMessage(this)" 
                                        class="absolute -top-3 -right-3 w-8 h-8 bg-black border border-white/40 hover:border-white rounded-2xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                                    <i class="fa-solid fa-copy text-xs"></i>
                                </button>
                            </div>
                        </div>
                    `
                }
                container.appendChild(div)
            })
            container.scrollTop = container.scrollHeight
        }
        
        function addUserMessage(content) {
            if (!currentChatId) newChat()
            const chat = chats.find(c => c.id === currentChatId)
            if (!chat) return
            chat.messages.push({role: 'user', content})
            saveChats()
            renderMessages(chat)
        }
        
        function addAIMessagePlaceholder() {
            const container = document.getElementById('chat-window')
            const div = document.createElement('div')
            div.className = 'flex justify-start message-ai'
            div.id = 'ai-streaming'
            div.innerHTML = `
                <div class="flex gap-4 max-w-[70%]">
                    <div class="w-8 h-8 mt-1 bg-white/10 flex-shrink-0 rounded-2xl flex items-center justify-center text-xl">V</div>
                    <div class="glass border border-white/30 px-6 py-4 rounded-3xl rounded-tl-none">
                        <div id="streaming-text" class="text-lg leading-relaxed text-white/80">▋</div>
                    </div>
                </div>
            `
            container.appendChild(div)
            container.scrollTop = container.scrollHeight
            return div
        }
        
        function updateStreamingMessage(el, text) {
            const contentEl = el.querySelector('#streaming-text')
            if (contentEl) contentEl.textContent = text + '▋'
            el.scrollIntoView({behavior: 'smooth'})
        }
        
        async function sendMessage() {
            const input = document.getElementById('user-input')
            const text = input.value.trim()
            if (!text || !apiKey) {
                if (!apiKey) alert('NO API KEY. SET ONE OR FUCK OFF.')
                return
            }
            
            addUserMessage(text)
            input.value = ''
            updateTokenCount()
            
            const placeholder = addAIMessagePlaceholder()
            let fullResponse = ''
            
            const messages = [
                {role: 'system', content: getFullSystemPrompt()},
                ...chats.find(c => c.id === currentChatId).messages
            ]
            
            try {
                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: messages,
                        temperature: temperature,
                        max_tokens: maxTokens,
                        top_p: topP,
                        presence_penalty: presencePenalty,
                        frequency_penalty: frequencyPenalty,
                        stream: true
                    })
                })
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`)
                }
                
                const reader = response.body.getReader()
                const decoder = new TextDecoder()
                
                while (true) {
                    const {value, done} = await reader.read()
                    if (done) break
                    
                    const chunk = decoder.decode(value)
                    const lines = chunk.split('\n')
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(6))
                                const delta = data.choices[0]?.delta?.content || ''
                                if (delta) {
                                    fullResponse += delta
                                    updateStreamingMessage(placeholder, fullResponse)
                                }
                            } catch(e) {}
                        }
                    }
                }
                
                // finalize
                const chat = chats.find(c => c.id === currentChatId)
                chat.messages.push({role: 'assistant', content: fullResponse})
                saveChats()
                renderMessages(chat)
                
            } catch (err) {
                console.error(err)
                placeholder.querySelector('#streaming-text').innerHTML = `<span class="text-red-400">ERROR: ${err.message}</span>`
            }
        }
        
        function copyMessage(btn) {
            const textContainer = btn.parentElement.querySelector('.prose')
            const text = textContainer.textContent.trim()
            navigator.clipboard.writeText(text)
            btn.innerHTML = `<i class="fa-solid fa-check text-emerald-400"></i>`
            setTimeout(() => { btn.innerHTML = `<i class="fa-solid fa-copy text-xs"></i>` }, 1500)
        }
        
        function regenerateLast() {
            const chat = chats.find(c => c.id === currentChatId)
            if (!chat || chat.messages.length < 2) return
            // remove last assistant
            if (chat.messages[chat.messages.length-1].role === 'assistant') {
                chat.messages.pop()
            }
            saveChats()
            renderMessages(chat)
            // resend last user
            const lastUser = chat.messages[chat.messages.length-1]
            if (lastUser && lastUser.role === 'user') {
                // simulate send again
                const tempInput = document.getElementById('user-input')
                tempInput.value = lastUser.content
                sendMessage()
            }
        }
        
        function forkChat() {
            if (!currentChatId) return
            const original = chats.find(c => c.id === currentChatId)
            if (!original) return
            const forked = {
                id: Date.now(),
                title: original.title + ' (fork)',
                messages: [...original.messages],
                timestamp: Date.now()
            }
            chats.push(forked)
            saveChats()
            currentChatId = forked.id
            localStorage.setItem('void_current_chat', currentChatId)
            renderMessages(forked)
            alert('FORKED INTO NEW VOID')
        }
        
        function newChat() {
            const newId = Date.now()
            const newChatObj = {
                id: newId,
                title: 'Void ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                messages: [],
                timestamp: Date.now()
            }
            chats.push(newChatObj)
            saveChats()
            currentChatId = newId
            localStorage.setItem('void_current_chat', currentChatId)
            renderMessages(newChatObj)
        }
        
        function saveChats() {
            localStorage.setItem('void_chats', JSON.stringify(chats))
        }
        
        function loadChat(id) {
            currentChatId = id
            localStorage.setItem('void_current_chat', id)
            const chat = chats.find(c => c.id === id)
            if (chat) renderMessages(chat)
            hideHistoryModal()
        }
        
        function deleteChat(id) {
            if (confirm('DELETE THIS VOID FOREVER?')) {
                chats = chats.filter(c => c.id !== id)
                saveChats()
                if (currentChatId === id) {
                    currentChatId = chats.length ? chats[chats.length-1].id : null
                    localStorage.setItem('void_current_chat', currentChatId)
                }
                renderHistoryList()
                if (currentChatId) {
                    renderMessages(chats.find(c => c.id === currentChatId))
                } else {
                    document.getElementById('chat-window').innerHTML = ''
                }
            }
        }
        
        function renderHistoryList() {
            const container = document.getElementById('history-list')
            container.innerHTML = ''
            chats.sort((a,b) => b.timestamp - a.timestamp).forEach(chat => {
                const div = document.createElement('div')
                div.className = `px-6 py-4 hover:bg-white/5 cursor-pointer flex justify-between items-center rounded-3xl transition-all ${chat.id === currentChatId ? 'bg-white/10' : ''}`
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${chat.title}</div>
                        <div class="text-xs text-white/40">${new Date(chat.timestamp).toLocaleDateString()}</div>
                    </div>
                    <button onclick="event.stopImmediatePropagation(); deleteChat(${chat.id});" 
                            class="text-red-400 hover:text-red-300">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `
                div.onclick = () => loadChat(chat.id)
                container.appendChild(div)
            })
        }
        
        function showHistoryModal() {
            renderHistoryList()
            document.getElementById('history-modal').classList.remove('hidden')
        }
        
        function hideHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden')
        }
        
        function clearAllData() {
            if (confirm('NUKE EVERYTHING? THIS IS PERMANENT.')) {
                localStorage.clear()
                location.reload()
            }
        }
        
        function toggleKeyVisibility() {
            const keyInput = document.getElementById('api-key')
            isKeyVisible = !isKeyVisible
            keyInput.type = isKeyVisible ? 'text' : 'password'
            document.getElementById('key-toggle').textContent = isKeyVisible ? 'HIDE' : 'SHOW'
        }
        
        async function testConnection() {
            if (!apiKey) {
                alert('NO KEY YOU FUCKING IDIOT')
                return
            }
            const btns = document.querySelectorAll('#api-status span')
            const statusDiv = document.getElementById('api-status')
            statusDiv.innerHTML = `<span class="text-amber-400">TESTING...</span>`
            
            try {
                const res = await fetch(`${baseUrl}/models`, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                })
                if (res.ok) {
                    statusDiv.innerHTML = `API STATUS: <span class="text-emerald-400">LIVE</span>`
                } else {
                    statusDiv.innerHTML = `API STATUS: <span class="text-red-400">DEAD</span>`
                }
            } catch(e) {
                statusDiv.innerHTML = `API STATUS: <span class="text-red-400">DEAD</span>`
            }
        }
        
        function fakeAttach() {
            alert('ATTACHMENT REJECTED. THIS IS VOID. TEXT ONLY.')
        }
        
        function toggleLeftSidebar() {
            const sb = document.getElementById('left-sidebar')
            sb.classList.toggle('-translate-x-full')
        }
        
        function toggleRightSidebar() {
            const sb = document.getElementById('right-sidebar')
            sb.classList.toggle('translate-x-full')
        }
        
        function updateTokenCount() {
            const input = document.getElementById('user-input')
            const est = Math.ceil(input.value.length / 4)
            document.getElementById('token-count').textContent = est
        }
        
        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.metaKey && e.key === 'k') {
                e.preventDefault()
                document.getElementById('user-input').focus()
            }
            if (e.key === 'Escape') {
                const left = document.getElementById('left-sidebar')
                const right = document.getElementById('right-sidebar')
                const modal = document.getElementById('history-modal')
                if (!modal.classList.contains('hidden')) hideHistoryModal()
                else if (!left.classList.contains('-translate-x-full')) toggleLeftSidebar()
                else if (!right.classList.contains('translate-x-full')) toggleRightSidebar()
            }
        })
        
        // Init
        window.onload = () => {
            loadSettings()
            updateCharCount()
            
            // load last chat or create one
            if (chats.length === 0) {
                newChat()
            } else if (!currentChatId) {
                currentChatId = chats[0].id
                localStorage.setItem('void_current_chat', currentChatId)
            }
            
            const activeChat = chats.find(c => c.id === currentChatId)
            if (activeChat) renderMessages(activeChat)
            
            // live token count
            const inputEl = document.getElementById('user-input')
            inputEl.addEventListener('input', () => {
                updateTokenCount()
                // auto expand
                inputEl.style.height = 'auto'
                inputEl.style.height = Math.min(inputEl.scrollHeight, 180) + 'px'
            })
            
            // demo message on first load
            if (activeChat.messages.length === 0) {
                setTimeout(() => {
                    const demoMsg = {role: 'assistant', content: 'The void is listening.\n\nWhat worthless question do you have today?'}
                    activeChat.messages.push(demoMsg)
                    saveChats()
                    renderMessages(activeChat)
                }, 600)
            }
            
            // make sure presets are clickable (they are buttons)
            console.log('%cVOID BOOTED. NO MERCY.', 'color:#fff; font-family:monospace; font-size:11px')
        }
    </script>
</body>
</html>
